# Implementation Plan: Rust Performance Optimizations

**Branch**: `002-rust-optimizations` | **Date**: 2025-02-05 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/002-rust-optimizations/spec.md`

## Summary

Implement 12 high-impact optimizations identified by Rust expert review plus achieve 100% test coverage. Focus areas: reduce heap allocations in hot paths, add inline hints, optimize XML parsing, tune Rayon thread pool, eliminate unnecessary Arc clones, pre-allocate collections, add derive traits, improve error context, batch progress updates, validate locale codes, tune buffer sizes, and add comprehensive documentation.

## Technical Context

**Language/Version**: Rust 1.75+
**Primary Dependencies**: rayon 1.10, quick-xml 0.31, indicatif 0.17, thiserror 2, clap 4, criterion 0.5 (bench), cargo-tarpaulin (coverage)
**Storage**: File system only (pub/static output)
**Testing**: cargo test + cargo-tarpaulin for 100% coverage measurement
**Target Platform**: Linux, macOS
**Project Type**: Single CLI binary with library crate
**Performance Goals**: 50k+ files/second, 25% faster than current baseline
**Constraints**: Memory peak < 256MB, no artificial limits
**Scale/Scope**: Handle 50k+ files per deployment

## Constitution Check

*GATE: All principles must PASS before proceeding*

| Principle | Status | Evidence |
|-----------|--------|----------|
| I. Performance First | PASS | All 6 high-priority optimizations target allocations and throughput |
| II. Memory Safety | PASS | No .unwrap() in production, proper error propagation maintained |
| III. Concurrency Excellence | PASS | Rayon tuning for I/O-bound work, atomic batching for progress |
| IV. Zero-Copy Optimization | PASS | FR-001 path joining, FR-003 XML zero-copy, FR-005 borrow over clone |
| V. Benchmarking Discipline | PASS | cargo bench baseline required before/after changes |

**Note**: Constitution states "MUST NOT create tests unless explicitly requested" - user explicitly requested 100% test coverage, so FR-013 is compliant.

## Project Structure

### Documentation (this feature)

```text
specs/002-rust-optimizations/
├── plan.md              # This file
├── research.md          # Technology decisions
├── data-model.md        # Core entities (existing)
├── quickstart.md        # Usage guide
├── contracts/           # Not applicable (CLI tool)
│   └── cli-interface.md # CLI contract (existing from 001)
├── checklists/
│   └── requirements.md  # Spec quality checklist
└── tasks.md             # Implementation tasks (generated by /speckit.tasks)
```

### Source Code (repository root)

```text
src/
├── main.rs      # CLI orchestration, Rayon execution
├── lib.rs       # Library exports for testing
├── config.rs    # Clap CLI parsing
├── theme.rs     # ThemeCode, LocaleCode newtypes, XML parsing
├── scanner.rs   # Theme discovery, file source scanning
├── deployer.rs  # Deploy jobs, parallel execution
├── copier.rs    # File copy with cancellation
└── error.rs     # Error types with thiserror

tests/
├── unit/
│   ├── theme_test.rs    # ThemeCode, LocaleCode, parse_theme_xml tests
│   ├── scanner_test.rs  # Theme discovery, source scanning tests
│   ├── deployer_test.rs # Deploy logic, job matrix tests
│   ├── copier_test.rs   # File copy, cancellation tests
│   └── config_test.rs   # CLI parsing tests
└── integration/
    └── deploy_test.rs   # End-to-end deployment tests

benches/
└── deploy_benchmark.rs  # Criterion benchmarks (existing)
```

**Structure Decision**: Existing flat module structure (6 modules) with dedicated test directory for comprehensive coverage.

## Complexity Tracking

> No Constitution violations requiring justification.

| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|-------------------------------------|
| N/A | All changes follow constitution principles | N/A |

## Implementation Phases

### Phase 1: Performance Optimizations (P1)

| ID | Requirement | Implementation |
|----|-------------|----------------|
| FR-001 | Minimize heap allocations | Replace `format!()` with `PathBuf::join()` in deployer.rs |
| FR-002 | Inline accessors | Add `#[inline]` to `ThemeCode::as_str()`, `LocaleCode::as_str()` |
| FR-003 | Zero-copy XML | Use `unescape_value()` instead of `to_vec()` in theme.rs |
| FR-004 | Thread pool tuning | Configure Rayon for I/O-bound (2× CPU cores) in main.rs |
| FR-005 | Avoid Arc clones | Pass `&Arc<Theme>` by reference in deployer.rs |
| FR-006 | Pre-allocate collections | Add `Vec::with_capacity()` in scanner.rs, deployer.rs |

### Phase 2: API Improvements (P2)

| ID | Requirement | Implementation |
|----|-------------|----------------|
| FR-007 | Equality traits | Add `PartialEq`, `Eq`, `Hash` derives to Theme, ThemeCode |
| FR-008 | Error context | Add source/dest paths to CopyFailed error variant |
| FR-009 | Batch progress | Implement thread-local counters with periodic flush |
| FR-010 | Locale validation | Add format check in LocaleCode::new() returning Result |
| FR-011 | Buffer tuning | Increase BUFFER_SIZE to 256KB in copier.rs |
| FR-012 | Documentation | Add doc comments to all public types and functions |

### Phase 3: Test Coverage (P3)

| ID | Requirement | Implementation |
|----|-------------|----------------|
| FR-013 | 100% coverage | Unit tests for all modules, integration tests for deployment flow |

**Coverage targets by module**:
- `theme.rs`: ThemeCode/LocaleCode construction, validation, XML parsing
- `scanner.rs`: Theme discovery, source scanning, module name extraction
- `deployer.rs`: Job matrix, deployment execution, error handling
- `copier.rs`: File copy, directory copy, cancellation, ENOSPC handling
- `config.rs`: CLI argument parsing, validation
- `error.rs`: Error formatting, Display implementations
